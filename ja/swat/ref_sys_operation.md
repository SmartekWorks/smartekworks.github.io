システムオペレーション
===

システムオペレーションは、ブラウザやシナリオを制御するためにシステム上に定義されたオペレーションです。

システムオペレーションの使い方
---

システムオペレーションの使用は[画面オペレーション](ref_web_operation.md)に非常に似ています。シナリオまたはフローにシステムオペレーションをドラッグ＆ドロップし、オペレーションのためのパラメータを入力します。しかしながら、画面オペレーションといくつかの違いがあります。

#### パラメータ

画面オペレーションとは異なり、システムオペレーションのパラメータは、以下のような特徴を持っています。

* パラメータを無視するチェックボックスがありません。
* パラメータのクエリモードがありません。
* アラートを処理する機能がオプションがありません。

#### エラーとエビデンス

各システムオペレーションは、独自に予め定義されたエラーやエビデンスを持っています。以下のシステムオペレーションの仕様を参照してください。

#### 変数の使用

* **変数名**タイプのパラメータで変数を設定することができません。 これらのパラメータは**画面変数設定**や **外部API呼び出し**オペレーションにあります。
* システムオペレーションでセレクトタイプのパラメータをクエリモードへ切り換えることができないように、**ブラウザ機能**オペレーションの**機能**のようなフィールドに変数を設定することはできません。

#### パラメータとオペレーションの無視

* 変数を無視することでシステムオペレーションのパラメータを無視することはできません。ただし、オペレーションで使用されているすべての変数を無視してオペレーション自身を無視することはできます。 
* **ブラウザ機能**や**追加エビデンス**オペレーションのようなシステムオペレーションで変数を使用することができないために、それらのオペレーションを無視することはできません。

オペレーション - URLに遷移
---

現在のブラウザセッションのアクティブなウィンドウで特定のURLに遷移します。 

#### パラメータ

| パラメータ | 説明
| ---------- | -----------
| サイト     | SWATで管理するサイト（SWATは、このオペレーションのを実行した後、このサイトの実行設定を使用します。）
| URL        | **サイト**の対象サーバーURLへの相対URL（`http://`, `https://`, `file://`でから始まる完全なURLを使用すると対象サーバーURLを無視することができます。） 

#### 注意事項

* ブラウザセッションがない場合は、新しいデフォルトのブラウザセッションとウィンドウを立ち上げます。

#### エラー

* **URL**と**サイト**の対象サーバーURLから生成されたURLは、空白または無効です。 （実行中）

#### エビデンス

* スクリーンショット
* HTML

オペレーション - ブラウザで待つ 
---

現在のブラウザセッションのウィンドウ内で短時間待ちます。 javascriptによってアップデートを待ちたいときに、このオペレーションを利用します。

#### パラメータ

| パラメータ | 説明
| ---------- | -----------
| 待ち時間（秒）   | 現在のブラウザセッションのウィンドウ内での待ち時間

#### 注意事項

* 長時間待つときには、セッションタイムアウトを注意する必要があります。
* クラウド実行サービスでのアイドルタイムアウトは約90秒です。 待機がタイムアウト時間を超えた場合、実行が中断されます。

#### エラー

* **待ち時間（秒）**の値は空白か自然数でない値。 （検証と実行中）

#### エビデンス

* スクリーンショット
* HTML

オペレーション - ブラウザ機能
---

ブラウザのナビゲーション制御機能をシミュレートします。

#### パラメータ

| パラメータ | 説明
| ---------- | -----------
| 機能     | ブラウザのナビゲーション制御機能: `進む`, `戻る`, `再読み込み`

#### 注意事項

* このシステムオペレーションは現在*Safari*上では動きません。
* ブラウザはフォーム送信後の`戻る`や`再読み込み`の動作を正しくない場合があります。

#### エラー

*  *Safari*でこのシステムオペレーションは実行します。 （実行中）

#### エビデンス

* スクリーンショット
* HTML

オペレーション - ファイル保存
---

前のオペレーションでダウンロードしたファイルを入手し、エビデンスとして保存します。このシステムオペレーションを使用する際は実行環境を設定する必要があります。*注意事項*を参照ください。

Note: OSの機能と関わり、シナリオが不安定になる恐れがあるため、シミュレートするための実際のダウンロードやアップロードをテストするのは良い方法ではありません。

#### パラメータ

| パラメータ    | 説明
| ------------- | -----------
| ダウンロード時間（秒）| ダウンロードが完了するまでの待ち時間

#### 注意事項

* このシステムオペレーションはローカル実行サービスでしか利用できません。
* ファイルが前のオペレーションで、特定のローカルディレクトリにダウンロードを行うようにする必要があります。ChromeとFirefoxの上で自動ダウンロードするように設定しています。ほかのブラウザの場合、ファイルを保存するダイアログを飛ばす設定の工夫が必要です。また、ブラウザで直接ファイルを開くことがないようにする必要があります。
* ローカル実行サービスでダウンロードディレクトリのパスを`"downloadDir"`にセットする必要があります。[実行サービスのセットアップ](setup_execservices.md#設定ファイル)を参照ください。

#### エラー

* **ダウンロード時間（秒）**の値は、空白か自然数でない値。（検証と実行中）
* クラウド実行サービスでこのシステムオペレーションは実行します。（実行中）
* ダウンロードに失敗または無効ダウンロードディレクトリが設定されるために、ダウンロードファイルは見つけることができません。（実行中）

#### エビデンス

* ダウンロードファイル

オペレーション - ウィンドウ制御
---

ターゲットウィンドウを見つけそれを操作します。

#### パラメータ

| パラメータ     | 説明
| -----------    | -----------
| ウィンドウ名    | ターゲットウィンドウの`"name"`。未記入の場合、この条件を無視
| マッチングルール | ターゲットウィンドウのマッチングルール（マッチングルールの詳細は[マッチング、クエリルール](ref_mq_rule.md#マッチングルールの仕様)を参照ください。未記入の場合、この条件を無視します。）
| アクション         | `切り替え`はターゲットウィンドウに切り替え（`閉じる`はターゲットウィンドウを閉じます。）

#### 注意事項

* もし、**ウィンドウ名**と**マッチングルール**の両方が指定されたら、両方ともに満足すべきです。 
* もし、**ウィンドウ名**と**マッチングルール**が空白なら、アクティブウィンドウがターゲットウィンドウです。

#### エラー

* **マッチングルール**は[マッチング、クエリルール](ref_mq_rule.md#マッチングルールの仕様)に準じません。（検証と実行中）
* ターゲットウィンドウは見つけることができません。（実行中）

#### エビデンス

* スクリーンショット
* HTML

オペレーション - 画面検証
---

アクティブウィンドウの画面は予想される画面がかどうかを検証します。

#### パラメータ

| パラメータ     | 説明
| -----------    | -----------
| マッチングルール | マッチングルールのファーマット（マッチングルールの詳細は[マッチング、クエリルール](ref_mq_rule.md#マッチングルールの仕様)を参照ください。未記入の場合、この条件を無視します。）

#### 注意事項

* 通常モードでエビデンスのエクスポートする際に**画面検証**オペレーションのエビデンスのみ含みます。よって、シナリオのチェックポイントとして**マッチングルール**を空白で使用することができます。

#### エラー

* **マッチングルール**は[マッチング、クエリルール](ref_mq_rule.md#マッチングルールの仕様)準じません。（検証と実行中）
* 検証条件を通さず、テストが失敗しました。（実行中）

#### エビデンス

* スクリーンショット
* HTML
* JSONテキストフォーマットのオペレーション結果

オペレーション - 画面変数設定
---

現在のウィンドウ画面からの値を変数に設定します。以下のオペレーションでパラメータとして使うことができます。

#### パラメータ

| パラメータ    | 説明
| ------------- | -----------
| クエリルール | 問い合せルールのフォーマットで目標値を定義（問い合わせルールの詳細は[マッチング、クエリルール](ref_mq_rule.md#クエリルールの仕様)を参照ください。）
| 変数名 | 変数名を格納

#### エラー

* **クエリルール**は空白か[マッチング、クエリルール](ref_mq_rule.md#クエリルールの仕様)に準じません。（検証と実行中） 
* **変数名**は空白か変数名のルールに準じません。（検証中）
* **変数名**は前のオペレーションを参照されます。（検証中）
* **クエリルール**のターゲットを見つけることができません。（実行中）

#### エビデンス

* JSONテキストフォーマットのオペレーション結果

オペレーション - 追加エビデンス
---

現在のウィンドウから追加情報を取得します。画面上のすべてセレクトのオプションリストや画面のURLを含みます。

#### パラメータ

* なし

#### エラー

* なし

#### エビデンス

* JSONテキストフォーマットの追加情報

オペレーション - 外部API呼び出し
---

シナリオ中でデータベースへアクセスすることや、ファイル操作をすることなどの拡張オペレーションを実行するために、シナリオから外部Webサービスを呼び出すことができます。 その場合、[エージェントAPI仕様](ref_agent_api.md)に準拠したエージェントサーバを構築する必要があります。 詳細は[データベース、ファイル操作](article_api_call.md)を参照ください。

#### パラメータ

| パラメータ    | 説明
| ------------- | -----------
| API URL       | APIのURL
| APIパラメータ    | APIのパラメータ、`Key1=Value1&Key2=Value2`のようなリクエストクエリ文字列フォーマットを使用
| 戻り用変数名 | APIの戻り値を結果に格納する変数名（値を設定する必要がない場合は空白のままにしておきます。）

#### 注意事項

* このシステムオペレーションはローカル実行サービス上でしか利用できません。
* **API URL**は改めて定義した一覧から選択することが可能です。詳細は[ツールと外部連携のセットアップ](setup_tools.md#エージェントAPIの連携)を参照ください。
* ターゲットサーバーのAPIは[エージェントAPI仕様](ref_agent_api.md)に準じます。

#### エラー

* **戻り用変数名**は変数名のルールに準じていません。（検証中）
* **戻り用変数名**を利用する際に、APIリターンに`result`キーが存在しません。（実行中）
* **APIパラメータ**は、リクエストクエリ文字列フォーマットに準じていません。（検証と実行中）
* クラウド実行サービスにこのシステムオペレーションを実行する。（実行中）
* **API URL**と**APIパラメータ**を使って、APIと正しく通信できません。（実行中） 

#### エビデンス

* JSONテキストフォーマットの戻り値

オペレーション - 実行中断
---

シナリオを一時停止し、一定の条件で再開します。すべてのブラウザセッションを閉じます。

#### パラメータ

| パラメータ     | 説明
| -------------  | -----------
| 中断タイプ     | 特定の時間を一時停止するための`中断時間指定`、特定の日付時刻に再開するための`再開時刻指定`
| 中断時間（分） | 一時停止の時間（`中断時間指定`タイプの下で動作します。）
| 再開日   | 一時停止したシナリオを再開するための日付（`当日`、 `翌日`）（再開時刻指定`タイプで**再開時刻**と一緒に動作します。）
| 再開時刻   | 一時停止したシナリオを再開するための時間 (時間単位)（`再開時刻指定`タイプで**再開日**と一緒に動作します。）

#### 注意事項

* この操作を実行するときに再開する日付時刻が既に過ぎている場合は、一時停止は無視されます。
* 再開した後、*URLに遷移*か、**セッション制御**オペレーションを使用して、新しいセッションを作成する必要があります。

#### エラー

* **一時停止期間**の値は、`中断時間（分）`タイプの下の空白か自然数ではありません。（検証と実行中）

#### エビデンス

* なし

オペレーション - セッション制御
---

シナリオでは複数のブラウザセッションを操作します。一シナリオで一セッションを使います。しかしながら、複数ブラウザで複数のユーザーをログインして操作をシミュレートしたい場合、複数セッションが必要です。

#### パラメータ

| パラメータ   | 説明
| ------------ | -----------
| アクション       | 新しいブラウザセッションを作成するための`立ち上げ`、現在のセッションにブラウザセッションを切り替える`切り替え`
| セッション名 | `立ち上げ`の場合、新しいセッション名、`切り替え`の場合、ターゲットセッション名、シナリオが最初に作成したデフォルトセッションのセッション名は`default`

#### 注意事項

* シナリオは一つづつオペレーションを実行し、一度に一つのアクティベートされたセッションを持つことになります。違うセッションのオペレーションを実行する前にそのセッションに切り替える必要があります。
* アクティベートされていないセッションのセッションタイムアウトに注意する必要があります。
* ローカルとクラウドの実行サービスで定義された最大並列セッションがあります。最大値を超えるセッションを持つシナリオは、実行サービスに入れられません。

#### エラー

* **セッション名**は空白。（検証と実行中）
* 既存の**セッション名**で新しいセッションを作成します。（実行中）
* 存在しない**セッション名**のセッションに切り替えます。（実行中）

#### エビデンス

* なし

