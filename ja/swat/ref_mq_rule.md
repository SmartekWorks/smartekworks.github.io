マッチング、クエリルール
===

マッチングルールとクエリールールは、Web画面上のデータを検証、取得するために使用されます。単純なシナリオを構築し、それをブラウザで自動的に実行したい場合は、これらルールは必要はありません。しかしながら、テスト効率を向上させ、複雑なシナリオ構築を支援するためには、これらのルールが必要です。

マッチングルールとは？
---

マッチングルールは、Web画面上の条件をアサートするために使用できるドメイン固有言語の一つとして書かれてます。SWATの以下の機能にマッチングルールを使用することができます。

#### シナリオの自動検証

[**画面検証**](ref_sys_operation.md#オペレーション_-_画面検証)システムオペレーションが自動検証を行うためのチェックポイントとして、シナリオへ追加します。このシステムオペレーションのパラメータとしてマッチングルールをセットする必要があります。実行するときに、SWATはウィンドウ内の画面でマッチングルールが通るかどうかどうかチェックします。もし条件が満たされない場合、エラーを報告します。 自動検証を行うことで、手動による全てのスクリーンショットをチェックせずにテストが成功したかどうかが判明します。

自動検証を行うには工夫が必要ですが、これを行うことで大幅にテスト効率を向上させることができます。特に回帰テストの場合、自動検証が必ず必要となります。

#### ブラウザウィンドウを特定

[**ウィンドウ制御**](ref_sys_operation.md#オペレーション_-_ウィンドウ制御)システムオペレーションを利用すると、ターゲットウィンドウを見つけ、それに対して操作することができます。このシステムオペレーションのパラメータとしてマッチングルールをセットする必要があり、それを実行するとき、SWATはマッチングルールが通った最初ウィンドウに切り替えたり、それを閉じたりすることができます。

#### 画面識別情報の定義

次の手順による画面ナレッジの識別としてマッチングルールを定義することができます。

1. ナレッジメニューから**画面ナレッジ**を開きます。
2. 左側のツリーにあるターゲット画面を選びます。
3. **保存**ボタンの隣の<span class="caret"></span>をクリックし、プルダウンメニューから**画面識別情報**を選び、 **画面識別情報**ダイアログを表示させます。
4. テキストエリアにマッチングルールを入力し保存します。

画面識別情報を定義したら、その画面上でオペレーションを実行する前に、マッチングルールによる画面検証を行います。それは、ターゲット画面に似ていて間違った画面で操作を実行しないようにするのに役立ちます。 

マッチングルールの仕様
---

マッチングルールは検証条件のJSONマップです。通常、SWATでは、複数のマッチングルールを含むJSONリストでマッチングルールを使用しています。下記サンプルを参照。 

```json
[
	{"target":"url", "have_text":"contract"},
	{"target":"title", "equal_text":"Search Results"}
]
```

### 構文

マッチングルールのJSONマップは、下記の三種類のキーが含まれています。

* `"frame"`: **（任意）** ターゲットフレームのnameかID。定義されていない場合、メインHTMLを使います。（フレームをしていない場合はこのキーの定義は不要です。）
```json
{"frame":"main", "have_text":"Success"}
```
* `"target"`: **（任意）** 評価対象。次の値を使用することができます。デフォルト値は`"body"`です。
```json
{"target":"url", "have_text":"contract"}
```
 * `"url"`: 画面のURLです。
 * `"title"`: 画面のタイトルです。
 * `"alert"`: 前回の動作に現れたすべてのアラートのテキストです。（`"alert"`タイプは、**画面検証**システムオペレーションのマッチングルールのみで使えます。）
 * *CSSセレクター*: CSSセレクターで定義される画面かフレーム（`"frame"`キー指定場合）のエリアです。例えば`"body"`, `"#Main"`。一つのHTMLに複数の論理ページがない限り、`"body"`使用をお勧めします。
* *評価式*: **（必須）** 以下のキーと値を指定することで、いくつかのタイプの評価式を使用することができます。
```json
{"target":"title", "equal_text":"Search Results"}
{"have_css":{"css":"button#btnOK", "with_text":"Go"}}
```
 * `"equal_text"`: 評価対象のテキストは、キーの文字列値に等しくなければなりません。
 * `"not_equal_text"`: 評価対象のテキストは、キーの文字列値に等しくありません。
 * `"have_text"`: 評価対象のテキストは、キーの文字列値に含まれます。
 * `"not_have_text"`: 評価対象のテキストは、キーの文字列値に含まれません。
 * `"have_css"`: 評価対象のエリアは、定義されたノードに含まれます。`"target"`は*CSSセレクター*の場合にのみ有効です。
 * `"not_have_css"`: 評価対象のエリアは、定義されたノードに含まれません。`"target"`は*CSSセレクター*の場合にのみ有効です。

`"have_css"`と`"not_have_css"`の値は、次のキーを含むJSONマップです。

```json
{"have_css":{"css":"button#btnOK", "with_text":"Go"}}
```

* `"css"`: **（必須）** CSSセレクタによって定義されたノードです。
* `"with_text"`: **（任意）** ノードの`text`は、キーの文字列値に等しい定義により、`"ccs"`に条件を追加することができます。
* `"with_part_text"`: **（任意）** ノードの`text`は、キーの文字列値を含む定義により、`"ccs"`に条件を追加することができます。
* `"with_value"`: **（任意）** ノードの`value`は、キーの文字列値に等しい定義ににより、`"ccs"`に条件を追加することができます。
* `"with_href"`: **（任意）** ノードの`href`は、キーの文字列値に等しい定義ににより、`"ccs"`に条件を追加することができます。hrefは実際のDOMからであり、HTMLで定義された相対URLの代わりで完全URLです。もしHTMLで定義されている`href`を使うなら、属性が一致するCSSセレクターを使うことができます。
* `"with_index"`: **（任意）** マッチしたノードのインデックス（`1`から始まる）は、キーの数値に等しい定義により、`"css"`に条件を追加することができます。
* `"enabled"`: **（任意）** ノードを有効にすべきかどうか（true/false）の定義により、`"css"`に条件を追加することができます。
* `"selected"`: **（任意）** ノードが選択されるべきかどうか（true/false）、`"css"`に条件を追加することができます。
* `"displayed"`: **（任意）** ノードが表示されるべきかどうか（true/false）、`"css"`に条件を追加することができます。SWATはデフォルトで`true`を使います。

### サンプル

* 画面のURLに`"contract"`の文字列を含む。
```json
{"target":"url", "have_text":"contract"}
```
* 画面のタイトルが`"Search Results"`に等しい。
```json
{"target":"title", "equal_text":"Search Results"}
```
* nameが`"main"`のフレームに`"Success"`の文字列を含む。
```json
{"frame":"main", "have_text":"Success"}
```
* 画面にIDが`"btnOK"`のボタンのtextが`"Go"`である。
```json
{"have_css":{"css":"button#btnOK", "with_text":"Go"}}
```
* 画面にIDが`"link1"`のリンクの遷移先が`"http://www.smartekworks.com/"`である。
```json
{"have_css":{"css":"#link1", "with_href":"http://www.smartekworks.com/"}}
```
* 画面にIDが`"btnBack"`のボタンが無効な状態。
```json
{"have_css":{"css":"#btnBack", "disabled":true}}
```
* 画面にIDが`"tblPersonel"`のテーブルの二行目に`"John"`の文字列を含む。
```json
{"have_css":{"css":"#tblPersonel tbody tr:nth-child(2)", "with_part_text":"John"}}
```
* 画面にnameが`"gender"`のラジオボタンの二つ目が選択された。
```json
{"have_css":{"css":"input[name='gender']", "with_index":2, "selected":true}}
```

クエリルールとは？
---

クエリルールは、画面から値を取得するために使用することができるドメイン固有言語の一つで書かれています。SWATの以下機能でクエリルールを使うことができます。

#### Web画面からの値を使い回す

複雑なシナリオでは、前のオペレーションの画面からの値を後続のオペレーションで使うことがあるかもしれません。例えば、*注文完了*画面で表示される*ご注文番号*を注文ステータス検索するために使うこととかです。

このような場合、[**画面変数設定**](ref_sys_operation.md#オペレーション_-_画面変数設定)システムオペレーションでWeb画面から値を取得し、後のオペレーションのパラメータで使用できるよう変数に保存すべきです。 このオペレーションのパラメータとしてクエリ-ルールをセットすることが必要で、それを実行している時、SWATはこのルールに従って値を取得します。

クエリルールの仕様
---

クエリルールはクエリ条件によるJSONのマップ文字列です。下記サンプルを参照。 

```json
{"source":"title"}
```

### 構文

クエリルールのJSONマップは、下記の三種類のキーが含まれています。

* `"frame"`: **（任意）** ターゲットフレームのnameかID。定義されていない場合、メインHTMLを使います。（フレームをしていない場合はこのキーの定義は不要です。）
```json
{"frame":"main", "source":"#orderNo", "css_key":"text"}
```
* `"source"`: **（必須）** 値の取得元です。次の値を使用することができます。
```json
{"source":"#selectGender", "css_key":"value"}
```
 * `"url"`: 画面のURL。クエリ文字列のパラメータ値を取得する`"query_key"`を使うことが必要です。
 * `"title"`: 画面のタイトルです。
 * `"alert"`: 前の操作に現れた最後のアラートのテキストです。
 * *CSSセレクター*: CSSセレクターで定義される画面かフレーム（`"frame"`キー指定場合）のノードです。ノードのテキストまたは属性を取得するために`"css_key"`を使う必要があります。
* `"query_key"`: **（`"source"`が`"url"`の場合、必須）** クエリ文字列のパラメータキーです。
```json
{"source":"url", "query_key":"orderNo"}
```
* `"css_key"`: **（`"source"`が*CSSセレクター*の場合、必須）** ノードの属性名です。また、ノードのテキストを取得するために`text`を使用することができます。
```json
{"source":"#selectGender", "css_key":"value"}
```
* `"css_index"`: **（`"source"`が*CSSセレクター*の場合有効、任意）** *CSSセレクター*に一致するいくつかのノードがある場合、ノードを指定するために`"css_index"`を使うことができます。 SWATはデフォルトで`1`を使います。
```json
{"source":"input[name='gender']", "css_key":"value", "css_index":2}
```

### サンプル

* 現在のURLにある`orderNo`のパラメータ値を使用。
```json
{"source":"url", "query_key":"orderNo"}
```
* 画面でnameが`"main"`のフレームでIDが`"orderNo"`の要素のテキスト値を使用。
```json
{"frame":"main", "source":"#orderNo", "css_key":"text"}
```
* IDが`"selectGender"`のセレクトに選択された項目のvalueを使用。
```json
{"source":"#selectGender", "css_key":"value"}
```
* IDが`"btnOrder"`であるボタンの`"name"`属性の値を使用。
```json
{"source":"#btnOrder", "css_key":"name"}
```
* nameが`"gender"`のラジオの二つ目のvalueを使用。
```json
{"source":"input[name='gender']", "css_key":"value", "css_index":2}
```

