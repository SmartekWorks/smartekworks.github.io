画面ナレッジカスタマイズ
===

このページでは、どのように画面ナレッジのチューニング（ナレッジルールを使って正しいオペレーションモデルを生成）を行い、JSから作られた特殊画面要素に対応する方法を説明します。

Note: このタスクを実施するにはHTMLやCSSの知識が必要ですが、ナレッジインポートのフェーズで必要なチューニングを行うことで、シナリオが楽に作成できます。

サンプルシナリオについて
---

先ほどの*Bingの検索*シナリオを少し変えて、*Bingの検索アシスタント*を使います。そのシナリオを以下参照ください。

1. *Bing* (http://www.bing.com) サイトへアクセスします。
2. 検索ボックスで適当なキーワードを入力します。
3. 検索プルダウンリストにキーワード候補が表示されます。
4. キーワード候補から適当なものを選択します。
5. *Bing*で選択したキーワードの結果ページが表示されます。

画面のインポート
---

*Bing検索アシスタント*のサンプルシナリオでは、検索アシスタントが動的に表示されている検索画面のHTMLが必要です。

1. **SWATキャプチャー**がインストールされたブラウザで、 http://www.bing.com サイトを開きます。
2. 検索ボックスに任意のキーワードを入力し、プルダウンにキーワード候補が表示されます。
3. ![SWAT icon](/swat/assets/images/extension.png)をクリックしキーワード候補が表示された画面を保存します。ファイル名を`BingSA.shtm`にリネームします。
4. 先ほどのガイドにあるインポート手順でSWATに`BingSA.shtm`をインポートします。

インポートした後に`BingSA`の画面の配下に`Bing`と同じように2つのオペレーションが存在します。肝心な検索プルダウンリストが出ていません。その理由は*Bing検索アシスタント*がJS+普通の`div`タグから作られたもののため、デフォルトのナレッジルールではこれが操作できる要素だと解釈していません。

画面ナレッジのチューニング
---

SWATは画面の実装を理解するためにナレッジルールを使います。SWATのデフォルトルールは、一般的なHTML実装を想定してますが、往々にして画面解析をしたときにルールをチューニングするカスタマイズが必要になります。

* Webアプリケーションでインタラクティブな要素を制御する特殊なJSがある場合。
* ノードを見つけるために特別なCSSクラスのような実装ポリシーを使用している場合。
* 自動抽出したオペレーションやノードのタイトルやスコープなどをデフォルトから変更したい場合。

#### デフォルトルール解析の分析

`BingSA`に検索アシスタントのプルダウンリストを意味するオペレーションが入っていない問題があります。プレビューフレームからHTMLを調べる場合、以下のHTMLコードを見つけるでしょう。

```html
<ul class="sa_drw" id="sa_ul">
	<li class="sa_sg" id="sa_0" url="/search?q=test&amp;qs=AS&amp;pq=test&amp;sc=8-4&amp;sp=1&amp;cvid=ae5d962746e843548572eca8e570130f&amp;FORM=QBLH" query="test" nav="sb_form_q;;sa_1;" stype="AS" hc="1" h="ID=autosuggest,5003.1" _ctf="sa_si_T" _ct="sa_0">
		<div class="sa_s"><div class="sa_tm">test</div></div>
	</li>
	...
</ul>
```

これは、プルダウンリストが複数`div.sa_s`のグループが入った`ul#sa_ul`リストによって実装されているためです。このようにインタラクティブなHTMLタグが存在しない場合、デフォルトルールでSWATはそれが操作可能だと認識しません。新しいナレッジルールを定義することで、SWATにこの種の実装を教え込みます。

#### ルールの設計

SWATナレッジルールは[画面ナレッジルール](ref_knowledge_rule.md)に準じるJSON文字列です。下記の基本コンポートを理解いただく必要があります。

* `singleNodes`: ボタンなど、入力として単一のインタラクティブなDOMノードの定義
* `collectionNodes`: リスト、テーブル、セレクトのようなDOMノードのコレクションを定義
* `operations`: オペレーションとなるcollectionNodeの抽出方法を定義

以下の手順でデフォルトルールが確認できます。

1. ナレッジメニューからチューニングを選択し、**画面チューニング**を開きます。
2. `Bing`サイトの`BingSA`画面を選びます。 ルールボタンをクリックし、プルダウンから**デフォルト**を選択します。
3. デフォルトルールが表示されます。

オペレーションに検索アシスタントのプルダウンリストを識別するには以下が必要です。

* `link`のような`div.sa_s`のためのクリック可能なノードを定義します。`singleNodes`に次のエントリーを追加する必要があります。
```json
"sa_link":{"selectors":["div.sa_s"], "decisive":true, "action":"click", "label":"link", "locator":"link"}, 
```
* `buttonGroup`のようなグループとして、`sa_link`を含む`ul#sa_ul`のcollection nodeを定義します。`collectionNodes`に次のエントリーを追加する必要がります。
```json
"sa_list":{"selectors":["ul#sa_ul"], "children":["sa_link"], "action":"or"},
```
* `sa_list`のためのオペレーションを定義します。 `operations`に次のエントリーを追加する必要がります。
```json
{"selectors": ["ul#sa_ul"], "collectionNode":"sa_list", "nesting":"outer"},
```

Hint: 詳細なリファレンスについては[画面ナレッジルール](ref_knowledge_rule.md)を参照してください。

#### ルールの作成

1. 上記の手順に従うと、上記の設計に応じてルールが変更されます。 
2. **プレビュー**ボタンをクリックし、 **プレビュー**タブで新しいルールの解析結果を参照します。
3. `sa_ul`の新しいオペレーションが追加されることを確認します。 
4. **ルール**タブに切り替え、**保存**ボタンをクリックし、タイトル`01`のルールを保存します。

Note: 同じ実装でも複数のルール定義の仕方があり、効率的にルールを作るためには多くのノウハウがあります。別章の**ノウハウ集**で、効率的にルールを作るためのベストプラクティスを説明する予定です。

#### ルールの適応

1. サービス設定メニューから**サイト設定**選択し、左側の`Bing`を選びます。
2. **解析ルール**を`01`へ変更し、このサイトのすべてのインポートは、このルールをデフォルトで使用することができます。
3. **ルール編集**ボタンをクリックし、**ルール管理**画面を表示させます。
4. ルール`01`を選び、 保存したルールを参照できます。
5. 次に**保存**ボタンのプルダウンメニューから**画面適応**を選択します。
6. すべての画面を選択し、対象画面の適応を行い、SWATは画面の解析を実施します。
7. しばらくしたら、左側に解析された画面リストを取得します。`Bing`は変更されてません。なぜなら検索アシスタントが含まれていないからです。`BingSA`は変更されたので、緑色に追加されたオペレーションが確認できます。

シナリオの作成と実行
---

1. 先ほど作成したテストセットの**シナリオ一覧**画面を開きます。
2. シナリオ`S0001`の前のチェックボックスにチェックをしますと、**コピー**ボタンがツールバーに表示されます。 
3. **コピー**ボタンのリストから**シナリオグループへ**をクリックし、モードに**シナリオのみをコピー**を選択して、`S0001`を複製します。
4. 新しく作成したシナリオ`S0002`の右端の<span class="caret"></span>をクリックし、**シナリオを編集**を選択します。シナリオビルダー画面が表示されます。
5. シナリオビルダー画面にフローの最後の*検索*オペレーションを選びます。
6. 今回のシナリオでは、*検索*ボタンをクリックする代わりに検索アシスタントの候補項目を選択する必要があります。そこで、パラメータを無視するように**アクション選択**の次のチェックボックスをオフにする必要があります。(パラメータを無視する方法の詳細は[画面オペレーション](ref_web_operation.md##パラメータの無視)を参照ください。)
7. *BingSA*下の*sa_ul*をドラッグ＆ドロップでシナリオ作成エリアへ、下段にセレクトボックスが表示されます。リストの内容は既にインポートしたナレッジ画面の情報を継承してます。
8. リストは入力に応じ変更されるため、<span class="glyphicon glyphicon-refresh"></span>アイコン（データ入力モードの切り替え）を二度クリックし、リストを**インデックスクエリモード**にします。フィールドへの入力値を変数`@{Index}`とし、ケース実行時にこの変数にセットされる何番目の項目を選択するということを意味します。（データ入力モードの詳細はここを[画面オペレーション](ref_web_operation.md#パラメータデータのクエリモード)参照ください。）
9. これでサンプルシナリオの作成は終了です。次にケースを追加します。
10. `S0002`のシナリオに、**Keyword**には`automation`とし、**Index**には`2`とします。これらの意味は、検索ボックスに`automation`を入力、候補リストの2番目の候補を選択することを指します。
11. 上記手順を繰り返えしで、**Keyword**と**Index**に`test`と`-1`を設定します。このケースの中で候補リストの最後のものを選びます。
12. 作成したシナリオとケースをそのまま実行し、結果を確認します。

次へ
----

SWATで自分たちのWebアプリケーションのUIテスト自動化にチャレンジしてみてください。様々な状況でSWATを使いこなすにはノウハウ集を参照ください。また、仕様の詳細を知りたい場合は、リファレンスを参照ください。