画面ナレッジのカスタマイズ
===

このページでは、どのように画面ナレッジのチューニング（ナレッジルールを使って正しいオペレーションモデルを生成）するか、どのように画面やオペレーションを編集するかを説明します。

Note: 画面ナレッジのチューニングが必須ではありませんが、利用者の使い勝手をよくするために、ナレッジベースを構築する際に画面ナレッジのチューニングを行うことをお勧めします。

画面ナレッジのチューニング
---

SWATは画面の実装を理解するためにナレッジルールを使います。SWATのデフォルトルールは、一般的なHTML実装を想定してますが、往々にして画面解析をしたときにルールをチューニングするカスタマイズが必要になります。

* Webアプリケーションでのインタラクティブな要素を制御する特殊なJSがある場合。
* ノードを見つけるために特別なCSSクラスのような特別な実装ポリシーを使用している場合。
* 自動抽出したオペレーションやノードのタイトルやスコープなどをデフォルトから変更したい場合。

#### デフォルトルール解析の分析

最初、`Bing`と`BingSA`画面のデフォルトルールでの解析結果を確認します。 `BingSA`に検索アシスタントのプルダウンリストを意味するオペレーションが入っていない問題があります。プレビューフレームからHTMLを調べる場合、以下のHTMLコードを見つけるでしょう。

```html
<ul class="sa_drw" id="sa_ul">
	<li class="sa_sg" id="sa_0" url="/search?q=test&amp;qs=AS&amp;pq=test&amp;sc=8-4&amp;sp=1&amp;cvid=ae5d962746e843548572eca8e570130f&amp;FORM=QBLH" query="test" nav="sb_form_q;;sa_1;" stype="AS" hc="1" h="ID=autosuggest,5003.1" _ctf="sa_si_T" _ct="sa_0">
		<div class="sa_s"><div class="sa_tm">test</div></div>
	</li>
	...
</ul>
```

これは、プルダウンリストが複数`div.sa_s`のグループが入った`ul#sa_ul`リストによって実装されているためです。このようにインタラクティブなHTMLタグが存在しない場合、デフォルトルールでSWATはそれが操作可能だと認識しません。新しいナレッジルールを定義することで、SWATにこの種の実装を教え込みます。

#### ルールの設計

SWATナレッジルールは[画面ナレッジルール](ref_knowledge_rule.md)に準じるJSON文字列です。下記の基本コンポートを理解いただく必要があります。

* `singleNodes`: ボタンなど、入力として単一のインタラクティブなDOMノードの定義
* `collectionNodes`: リスト、テーブル、セレクトのようなDOMノードのコレクションを定義
* `operations`: オペレーションとなるcollectionNodeの抽出方法を定義

以下の手順でデフォルトルールが確認できます。

1. ナレッジメニューからチューニングを選択し、**画面チューニング**を開きます。
2. `Bing`サイトの`BingSA`画面を選びます。 ルールボタンをクリックし、プルダウンから**デフォルト**を選択します。
3. デフォルトルールが表示されます。

オペレーションに検索アシスタントのプルダウンリストを識別するには以下が必要です。

* `link`のような`div.sa_s`のためのクリック可能なノードを定義します。`singleNodes`に次のエントリを追加する必要があります。
```json
"sa_link":{"selectors":["div.sa_s"], "decisive":true, "action":"click", "label":"link", "locator":"link"}, 
```
* `buttonGroup`のようなグループとして、`sa_link`を含む`ul#sa_ul`のcollection nodeを定義します。`collectionNodes`に次のエントリーを追加する必要がります。
```json
"sa_list":{"selectors":["ul#sa_ul"], "children":["sa_link"], "action":"or"},
```
* `sa_list`のためのオペレーションを定義します。 `operations`に次のエントリーを追加する必要がります。
```json
{"selectors": ["ul#sa_ul"], "collectionNode":"sa_list", "nesting":"outer"},
```

Hint: 詳細なリファレンスについては[画面ナレッジルール](ref_knowledge_rule.md)を参照してください。

#### ルールの作成

1. 上記の手順に従うと、上記の設計に応じてルールが変更されます。 
2. **プレビュー**ボタンをクリックし、 **プレビュー**タブで新しいルールの解析結果を参照します。
3. `sa_ul`の新しいオペレーションが追加されることを確認します。 
4. **ルール**タブに切り替え、**保存**ボタンをクリックし、タイトル`01`のルールを保存します。

Note: 同じ実装でも複数のルール定義の仕方があり、効率的にルールを作るためには多くのノウハウがあります。別章の**ノウハウ集**で、効率的にルールを作るためのベストプラクティスを説明する予定です。

#### ルールの適応

1. サービス設定メニューから**サイト設定**選択し、左側の`Bing`を選びます。
2. **解析ルール**を`01`へ変更し、このサイトのすべてのインポートは、このルールをデフォルトで使用することができます。
3. **ルール編集**ボタンをクリックし、**ルール管理**画面を表示させます。
4. ルール`01`を選び、 保存したルールを参照できます。
5. 次に**保存**ボタンのプルダウンメニューから**画面適応**を選択します。
6. すべての画面を選択し、対象画面の適応を行い、SWATは画面の解析を実施します。
7. しばらくしたら、左側に解析された画面リストを取得します。`Bing`は変更されてません。なぜなら検索アシスタントが含まれていないからです。`BingSA`は変更されたので、緑色に追加されたオペレーションが確認できます。

画面とオペレーションの編集
---

ナレッジルールは同じWebアプリケーションで共通の画面や似通った実装の画面が多いとき助かります。時に個別のナレッジコンポーネントのタイトルとして、いくつかの属性を変更する必要があります。

1. ナレッジメニューから**画面ナレッジ**を選択します。
2. `Bing`下の`hp_table`を選択、タイトルを`Links`に変更します。保存後、左側ツリーでタイトルが変わったことを確認します。
3. また`BingSA`下の`hp_table`のタイトルも`Links`に変更されています。SWATは、それらが別のページに同じ操作であると認識しているためです。**保存**ボタンのプルダウンメニューで**関連オペレーション**を選択することでそのリレーションを削除することができます。
4. また、`sb_form`のタイトルを `Search`、`sa_ul`を `Suggestion List`へ変更できます。
5. `BingSA`下の`Search`を選択します。 次に**保存**ボタンのプルダウンメニューから **カスタマイズ**選択します。 **カスタマイズ**画面が表示します。
6. `sa_ghostbox`という隠れたノード名を確認します。実行時にそれを必要としないので、それを無効にするには、ノードのチェックを外します。ここではノードのタイトルを変更することができます。

次へ
----

これで画面ナレッジが使えるようになりました。次は画面オペレーションを使ってシナリオの作成する方法を説明します。

[シナリオ作成](guide_scenarios.md)へ。