エージェントAPI仕様
===

シナリオ中にデータベースへアクセスすることとか、ファイル操作をすることなどの拡張オペレーションを実行するために、シナリオに外部Webサービスを呼び出すことができます。 その場合、ここで説明したAPI仕様に準拠したエージェントサーバを構築する必要があります。

また、エージェントサーバーの利用例については、[データベース、ファイル操作](article_api_call.md)を参照することができます。

エージェントサーバーの仕組み 
---

SWATローカル実行サービス上でケースを実行すると、SWATはシナリオのすべてのステップを実行するためローカル実行サーバーに指示をします。ステップのほとんどは、ブラウザでWebページ上の操作を行いますが、時には電子メールで誰かに通知する、DBへのアクセスをする、ファイルの操作をする、といったような何かをする必要があります。シナリオの中で、このような場面をサポートするため、**外部API呼び出し**システムオペレーションを利用して、必要な機能を行うためのエージェントAPIを呼び出す必要があります。

エージェントAPIからリクエストをもらい、エージェントサーバーがDBアクセスのような操作を行い、その結果を返答します。結果を得た後は、SWATは後のステップを実行し続けます。

上記のように、エージェントサーバーは、SWATローカル実行サーバーによりコールされ、特別なオペレーションを行い、SWATに結果を返すWebサービスです。

Note: **外部API呼び出し**システムオペレーションとエージェントサーバーはローカル実行サービスでしか動きません。

エージェントAPI仕様
---

**外部API呼び出し**システムオペレーションは、以下仕様でエージェントサーバーをコールします。この仕様に従ってエージェントサーバーを実装する必要があります.

#### リクエスト

* URL: **外部API呼び出し**システムオペレーションの**API URL**で定義されているURL。
* Method: `POST`
* Content-Type: `application/json`
* Parameters: `sessionId`と言うケースの実行セッションを示す内部パラメータのみ。
* Body: **外部API呼び出し**システムオペレーションの**APIパラメータ**で定義したパラメーターがJSONマップ方式に変換したデータです。

#### レスポンス 

エージェントAPIはコールが成功したとき、次の応答を返す必要があります。 

* HTTP Code: `200`
* Content-Type: `application/json`
* Body: 以下キーを持つJSONマップ
 * `result`: **（任意）** **外部API呼び出し**システムオペレーションの**変数名**で定義された変数に保存する文字列。**変数名**が設定される場合に必須となります。 
 * `extraEvidences`: **（任意）** SWATでエビデンスとして保存するファイルのリスト。
   * `name`: **（必須）** ファイルの名。
   * `type`: **（必須）** ファイルのMimeタイプ。
   * `content`: **（必須）** バイナリーファイルのコンテンツ。エンコードBASE64で使用。

エージェントAPIはコールが失敗した時、以下レスポンスを返します。

* HTTP Code: `404`
* Content-Type: `application/json`
* Body:以下キーを持つJSONマップ
 * `code`: **（任意）** コールのエラーコード。SWATのエラーメッセージで表示されます。
 * `message`: **（必須）** コールのエラーメッセージ。SWATのエラーメッセージで使用します。

Note: リクエストのタイムアウトが10分であるため、エージェントサーバーは10分以内に処理して、レスポンスを返す必要があります。

エージェントAPIのサンプル
---

ユーザーのアップロード管理アプリをサンプルとして、エージェントAPIについて説明します。ユーザがファイルをアップロードした後、DBおよびアップロードされたファイルから*fileNo*を取得する必要があります。 その後、同じアプリでファイルの詳細を検索する必要があります。

#### SWATシナリオについて

アップロードのフローの後ろに、以下のパラメータで**外部API呼び出し**システムオペレーションを追加。

* API URL: `http://127.0.0.1/traceUpload`
* API Params: `db=true&file=true`
* Variable Name: `@{fileNo}`

このシステムオペレーションの後に、ファイルを検索するように、変数 `fileNo`を使用して*ファイル検索*オペレーションが利用できます。

#### エージェントサーバーについて

SWATは、上記の操作を実行すると、次のようなJSON POSTリクエストを出します。

* URL: `http://127.0.0.1/traceUpload`
* Parameters: `sessionId=12345`
* Body:
```json
{
	"db":"true",
	"file":"true"
}
```

上記のリクエストを受け入れるようにSQLクエリやアップロードファイルの読み込みでファイルの番号とファイルそのものを取得するエージェントサーバーを実装する必要があります。その後、エージェントサーバーは、次のレスポンスを返す必要があります。

* HTTP Code: `200`
* Content-Type: `application/json`
* Body:
```json
{
	"result":"123",
	"extraEvidences":[
		{
			"name":"file0513.pdf",
			"type":"application/pdf",
			"content":"ファイルの内容"
		}
	]
}
```

このようにして、ファイル名`file0513.pdf`はアップロードされ、そのファイルがエビデンスとして保存されます。そして、ファイル番号`123`を使ってファイルの詳細を検索します。
