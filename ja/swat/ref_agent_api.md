エージェントAPI仕様
===

シナリオ中に、DBアクセスのような拡張オペレーションを実行し、ファイルを操作するWebサービスを呼び出すために[** API Call**システムオペレーション]（ref_sys_operation.md＃操作_-_ API_Call）を使用することができます。拡張操作はここで説明したAPI仕様に準拠して、エージェントサーバを構築する必要があります。

また、エージェントサーバを使用するための注意事項については、[DBアクセスとファイル操作]（article_api_call.md）を参照することができます。

エージェントサーバは、どのように動作しますか？ 
---

SWATローカル実行サービス上でケースを実行すると、SWATはシナリオのすべてのステップを実行するためローカル実行サーバに指示をします。ステップのほとんどは、ブラウザでWebページ上のいくつかの操作を行いますが、時には電子メールで誰かに通知する、DBへのアクセスをする、ファイルの操作をする、といったような何かをする必要があります。シナリオの中で、ユースケースのようなものをサポートするため、エージェントAPIを呼び出し、既存のWebサービスを呼び出すために特別な手順が必要です。

エージェントサーバーがエージェントAPIを使ってDBアクセスのような操作を行い、その結果を返答します。結果を得た後は、SWATは後の手順を実行し続けます。

エージェントサーバーは、SWATローカル実行サーバーによりコールされ、コールのための実装はなしにSWATに結果を返します。

ノート: システムオペレーションの**API Call**やエージェントサーバーはローカル実行サービスでしか動きません。

エージェントAPI仕様
---

システムオペレーションの**API Call**は、以下仕様でエージェントAPIをコールします。この仕様に独自のAPIを実装する必要があります.

#### 要求

* URL: **API　Call**システムオペレーションのパラメータで、**API　URL**で定義されているURL
* Method: `POST`
* Content-Type: `application/json`
* Parameters: `sessionId`と言う内部パラメーターの一つでケースの実行セッションを指示するための設定です。
* Body: JSON Mapを記憶するためのシステムオペレーションんの**API Call**の**API Params**パラメータです。

#### レスポンス 

エージェントAPIはコールが成功したとき、次の応答を返す必要があります。 

* HTTP Code: `200`
* Content-Type: `application/json`
* Body: 以下キーを持つJSON Map
 * `result`: システムオペレーション**API Call**のパラメータ**変数名**で定義された変数に保存することができる**(オプション)**文字列。 それは変数名を設定するときに必要です。 
 * `extraEvidences`: SWATでエビデンスとして保存する**(オプション)**ファイルのリスト。
   * `name`: ファイルの**(Required)**名。
   * `type`: ファイルの**(Required)** Mimeタイプ。
   * `content`: バイナリーファイルの**(Required)**コンテンツ。エンコード BASE64で使用。

エージェントAPIはコールが失敗した時、以下レスポンスを返します。

* HTTP Code: `404`
* Content-Type: `application/json`
* Body:以下キーを持つJSON Map
 * `code`: コールの**(Optional)**エラーコード。SWATのエラーメッセージで使用。
 * `message`: コールの**(Required)**エラーコード。SWATのエラーメッセージで使用。

ノート: リクエストのタイムアウトが10分であるため、エージェントサーバはプロセスを完了の確認をし10分以内に返す必要があります。

エージェントAPIのサンプル
---

ユーザーのアップロード·アプリケーション·サンプルとエージェントAPIについて説明します。ユーザがファイルをアップロードした後、DBおよびアップロードされたファイルから*fileNo*を取得する必要があります。 その後、同じアプリケーションでファイルの詳細を検索する必要があります。

#### SWATシナリオについて

以下のパラメータでシステムオペレーションの**API Cal**を追加

* API URL: `http://127.0.0.1/traceUpload`
* API Params: `db=true&file=true`
* Variable Name: `@{fileNo}`

システムオペレーションの後、ファイルを検索するように、変数 `fileNo`を使用して*検索アップロードファイル*ウェブオペレーションを追加する必要があります。

#### エージェントServerについて

SWATは、上記の操作を実行すると、次のようなJSON POST要求が行われます。

* URL: `http://127.0.0.1/traceUpload`
* Parameters: `sessionId=12345`
* Body:
```json
{
	"db":"true",
	"file":"true"
}
```

上記の要求を受け入れるようにエージェントサーバを実装する必要があり、SQLクエリを実行やアップロードファイルの読み込みで。 その後、エージェントサーバは、次の応答を返す必要があります。

* HTTP Code: `200`
* Content-Type: `application/json`
* Body:
```json
{
	"result":"file0513",
	"extraEvidences":[
		{
			"name":"file0513.pdf",
			"type":"application/pdf",
			"content":"...."
		}
	]
}
```

このようにして、ファイル名`file0513.pdf`はアップロードされ、、システムオペレーションのためのエビデンスとして保存されます。 そして、file`sの詳細を検索するには、 `file0513`を使用します。
