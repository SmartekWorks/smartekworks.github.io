フローの活用
===

シナリオを簡単に再利用したり、簡単に編集できるようにするためには、フローを活用しシナリオをカプセル化することをお勧めします。

フローとは？
---

簡単に説明しますと、Webオペレーションを複数組み合わせ、それを一つにまとめたサブシナリオのイメージです。このようなサブシナリオを再利用し、サブシナリオの組合せ（フローの組合せ）で簡単にシナリオを作成できます。また、フロー内でWebオペレーションが変更されても、そのシナリオ自体を変更する必要はありません。

しかし、フローの意味は共通のサブシナリオよりも更に進んでます。

フローを使用すると、Webアプリケーションの操作を知らずにシナリオを構築することができます。 例えば、フローでビジネスルールに基づいたシナリオが作成できます。以下参照ください。

1. インターネットバンキングのサイトにログインします。
2. 口座残高を確認します。
3. 誰かに2万円振り込みます。
4. 口座残高（-2万円)を再度確認します。

フローは特定のビジネスで目的を達成するための一連のオペレーションを定義しているため、上記のシナリオを作成する際に、インターネットバンキングサイトとやり取りする方法を知る必要はありません。

Hint: ビジネス上で意味を持つフローを作成することがベストプラクティスです。

なぜフローを使うか？
---

では、フローを使うメリットを以下にまとめます。

* シナリオを簡単に作成できることで、そのシナリオが理解し易い（解り易い）。
* シナリオを簡単に作成できることで、より効率的な作業を可能にする。
* シナリオの保守が簡単になる。
* 画面ナレッジを準備する前にシナリオが作成できる。

フローの作成
---

フローを作成するには、下記操作を参照ください。

1. ナレッジメニューから**フロー**を選び、**フローナレッジ** 画面を表示します。(既存のフローが無い場合は、**フロービルダー**画面が表示されます）
2. <span class="glyphicon glyphicon-plus"></span>ボタンをクリックし、新しいフローを追加します。 **フロービルダー**画面が表示されます。
3. ドラッグ＆ドロップでシステムオペレーションやWebオペレーションを組み立て、それらのオペレーションのパラメータを入力します。
4. フロー内のパラメータ値を変数にする場合が多いです。シナリオでこのフローを使用するときは、それら変数で指定した箇所に値を設定することができます。
5. フロータイトルを入力し、**新規**ボタンをクリックするとフローの作成が完了します。
6. **フローナレッジ**画面では、 フローのパラメータと各ステップ情報を含むフロー情報を参照することができます。

フローの利用
---

[Webオペレーション](ref_web_operation.md#How_to_Use_Web_Operations?)を使うように、 **テストシナリオビルダー**画面でフローがドラッグ＆ドロップできます。しかし、フローとWebオペレーションとは、いくつか違う点があります。

#### パラメータ

フローのパラメータはフロー内で使う変数で、Webオペレーションのパラメータは画面ナレッジからです。そのため、Webオペレーションのパラメータの以下のような特徴を持っています。

* パラメータタイプは`Text`のみ。
* パラメータのクエリモードがない。
* アラートを処理する機能がオプションにない。

また、フローパラメータをシナリオパラメータとして使うことが多いので、フローをシナリオにドラッグ＆ドロップする際に、自動的にそのパラメータ名を使用した変数をパラメータに記入します。

#### エラーとエビデンス

フローがコンテナであるため、エラーやエビデンスがありません。

#### フローを無視

Webオペレーションの無視と同じく、ケースデータダイアログに特定なフローに関連するすべての変数の**パラメータ有効**チェックボックスをオフにしたときに、実行中に特定なフローを無視することができます。（ケースの出力、インポートでのケース設定でも利用可能です。）

BeforeとAfterフィルター
---

通常のフロー以外に二種類の特別なフローがあります。それは**Beforeフィルター**と**Afterフィルター**です。前者がテストセットのすべてのケースを実行する前に実行する前処理です。後者が後処理です。ケースでエラーが発生した後に**Afterフィルター**も実行します。

#### フィルターの作成

テストセットの配下に`before`タグが付いている**シナリオグループ**を作成すれば、そのグループの配下のすべてのシナリオとケースがBeforeフィルターになります。また、Afterフィルターも同様に`after`タグを使えば作れます。フィルターとなるシナリオグループから上記の特殊タグを外したら、普通なシナリオグループになります。

テストセットに複数フィルターがある場合、または１フィルターに複数シナリオがある場合、シナリオが順番に実行されます。またシナリオに複数ケースがある場合、１番目のケースしか実行されません。

#### フィルターデータの書き換え

通常テストセット単位でフィルターが同じデータで実行されますが、ケースごとフィルターごとに違うデータを利用する場合もあります。例えば、ケースごとにログイン用Beforeフィルターで違うログイン情報（パラメータ：UserID、Password）を利用したい場合、それぞれのケースの**フィルターデータ**下記のJSONフォーマットのデータ置換ルールを記入すれば良いです。

```json
{"UserID":"User A", "Password":"Password A"}
```

```json
{"UserID":"User B", "Password":"Password B"}
```
**フィルターデータ**が定義しない場合、フィルターのケースに定義したデータをそのまま利用します。
